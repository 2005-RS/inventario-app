<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de Inventario - Suplementos</title>

  <!-- ‚úÖ PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }

    .header h1 { color: #333; font-size: 2.2em; margin-bottom: 10px; }
    .header p { color: #666; font-size: 1.05em; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; }
    .stat-card .value { font-size: 2em; font-weight: bold; }
    .stat-card .icon { font-size: 3em; opacity: 0.3; }

    .controls {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.25s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-1px); }

    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }

    .btn-info { background: #3b82f6; color: white; }
    .btn-info:hover { background: #2563eb; }

    .search-filter { display: flex; flex-wrap: wrap; gap: 15px; }

    .search-box { flex: 1; min-width: 250px; position: relative; }

    .search-box input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    .search-box input:focus { outline: none; border-color: #667eea; }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    select {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      background: white;
    }

    .form-container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: none;
    }

    .form-container.active { display: block; }
    .form-container h2 { margin-bottom: 20px; color: #333; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-grid input, .form-grid select {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
    }

    .form-grid input:focus, .form-grid select:focus {
      outline: none;
      border-color: #667eea;
    }

    .hint {
      font-size: 0.9em;
      color: #6b7280;
      margin-top: -8px;
      margin-bottom: 10px;
    }

    .table-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; }
    thead { background: #667eea; color: white; }
    thead th { padding: 15px; text-align: left; font-weight: 600; }

    tbody tr { border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s; }
    tbody tr:hover { background: #f9fafb; }

    tbody tr.stock-bajo { background: #fee2e2; }
    tbody tr.stock-bajo:hover { background: #fecaca; }

    /* ‚úÖ filas por vencimiento */
    tbody tr.vencido { background: #ffe4e6 !important; }
    tbody tr.por-vencer { background: #fef3c7 !important; }

    tbody td { padding: 15px; }

    .categoria-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 700;
      background: #ddd6fe;
      color: #5b21b6;
    }

    .stock-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .stock-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2em;
      transition: all 0.2s;
    }

    .stock-btn.minus { background: #ef4444; color: white; }
    .stock-btn.plus { background: #10b981; color: white; }
    .stock-btn:hover { transform: scale(1.08); }

    .stock-value { font-weight: bold; min-width: 40px; text-align: center; }

    .action-btns { display: flex; gap: 10px; justify-content: center; }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      transition: transform 0.2s;
      font-size: 1.1em;
    }

    .icon-btn:hover { transform: scale(1.2); }
    .icon-btn.edit { color: #3b82f6; }
    .icon-btn.delete { color: #ef4444; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    /* ‚úÖ Panel vencimientos */
    .alert-panel{
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .alert-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
    }

    .alert-head h2{
      color:#111827;
      font-size: 1.2em;
    }

    .alert-meta{
      color:#6b7280;
      font-size: 0.95em;
      font-weight: 700;
    }

    .alert-cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .alert-box{
      border-radius: 12px;
      padding: 12px;
      border: 2px solid #e5e7eb;
    }

    .alert-expired{
      border-color: #ef4444;
      background: #fff1f2;
    }

    .alert-soon{
      border-color: #f59e0b;
      background: #fffbeb;
    }

    .alert-box h3{
      margin-bottom: 10px;
      font-size: 1.05em;
      color: #111827;
    }

    .alert-list{
      display:flex;
      flex-direction:column;
      gap: 8px;
      max-height: 200px;
      overflow:auto;
      padding-right: 6px;
    }

    .alert-item{
      background: rgba(255,255,255,0.86);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .alert-item strong{
      display:block;
      margin-bottom: 4px;
      color:#111827;
    }

    .alert-item small{
      color:#374151;
      font-weight: 700;
    }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.6em; }
      .stats { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .table-container { overflow-x: auto; }
      table { min-width: 980px; }
      .alert-cols{ grid-template-columns: 1fr; }
      .alert-list{ max-height: 260px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üì¶ Control de Inventario - Suplementos</h1>
      <p>Gestiona tu inventario de manera eficiente (con vencimientos ‚úÖ)</p>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div>
          <h3>Total Productos</h3>
          <div class="value" style="color: #667eea;" id="totalProductos">0</div>
        </div>
        <div class="icon">üì¶</div>
      </div>

      <div class="stat-card">
        <div>
          <h3>Valor Inventario</h3>
          <div class="value" style="color: #10b981;" id="valorInventario">‚Ç°0.00</div>
        </div>
        <div class="icon">üí∞</div>
      </div>

      <div class="stat-card">
        <div>
          <h3>Stock Bajo</h3>
          <div class="value" style="color: #ef4444;" id="stockBajo">0</div>
        </div>
        <div class="icon">‚ö†Ô∏è</div>
      </div>

      <div class="stat-card">
        <div>
          <h3>Categor√≠as</h3>
          <div class="value" style="color: #8b5cf6;" id="totalCategorias">7</div>
        </div>
        <div class="icon">üìÇ</div>
      </div>
    </div>

    <div class="controls">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="toggleFormulario()">‚ûï Agregar Producto</button>
        <button class="btn btn-success" onclick="exportarExcel()">‚¨áÔ∏è Exportar Excel</button>

        <label class="btn btn-info">
          ‚¨ÜÔ∏è Importar Excel
          <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="importarExcel(event)">
        </label>

        <button class="btn btn-success" onclick="guardarJSON()">üíæ Respaldo (JSON)</button>

        <label class="btn btn-info">
          üìÇ Restaurar (JSON)
          <input type="file" id="importJSON" accept=".json" style="display: none;" onchange="cargarJSON(event)">
        </label>
      </div>

      <div class="search-filter">
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" id="busqueda" placeholder="Buscar por nombre o c√≥digo..." oninput="filtrarProductos()">
        </div>

        <select id="filtroCategoria" onchange="filtrarProductos()">
          <option value="todos">Todas las categor√≠as</option>
          <option value="Prote√≠nas">Prote√≠nas</option>
          <option value="Vitaminas">Vitaminas</option>
          <option value="Amino√°cidos">Amino√°cidos</option>
          <option value="Pre-Entreno">Pre-Entreno</option>
          <option value="Creatina">Creatina</option>
          <option value="Quemadores">Quemadores</option>
          <option value="Otros">Otros</option>
        </select>
      </div>
    </div>

    <div class="form-container" id="formContainer">
      <h2 id="formTitle">Nuevo Producto</h2>

      <div class="form-grid">
        <input type="text" id="codigo" placeholder="C√≥digo">
        <input type="text" id="nombre" placeholder="Nombre *" required>

        <select id="categoria">
          <option value="">Seleccionar categor√≠a</option>
          <option value="Prote√≠nas">Prote√≠nas</option>
          <option value="Vitaminas">Vitaminas</option>
          <option value="Amino√°cidos">Amino√°cidos</option>
          <option value="Pre-Entreno">Pre-Entreno</option>
          <option value="Creatina">Creatina</option>
          <option value="Quemadores">Quemadores</option>
          <option value="Otros">Otros</option>
        </select>

        <input type="number" id="precio" placeholder="Precio *" step="0.01" required>
        <input type="number" id="stock" placeholder="Stock *" required>
        <input type="number" id="stockMinimo" placeholder="Stock M√≠nimo" value="5">
        <input type="text" id="proveedor" placeholder="Proveedor">

        <!-- ‚úÖ Fecha vencimiento -->
        <input type="text" id="vence" placeholder="Vence (dd/mm/aaaa o ddmmaaaa)">
      </div>

      <div class="hint">
        Ejemplos: <b>01/12/2026</b> o <b>12012026</b> (12/01/2026). Si lo dej√°s vac√≠o, no se eval√∫a.
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="guardarProducto()">üíæ Guardar</button>
        <button class="btn" style="background: #6b7280; color: white;" onclick="cancelarFormulario()">‚ùå Cancelar</button>
      </div>
    </div>

    <!-- ‚úÖ Panel vencimientos -->
    <div class="alert-panel" id="alertPanel" style="display:none;">
      <div class="alert-head">
        <h2>üìÖ Vencimientos</h2>
        <div class="alert-meta" id="alertMeta"></div>
      </div>

      <div class="alert-cols">
        <div class="alert-box alert-expired">
          <h3>üî¥ Vencidos</h3>
          <div class="alert-list" id="listaVencidos"></div>
        </div>

        <div class="alert-box alert-soon">
          <h3>üü° Prontos a vencer</h3>
          <div class="alert-list" id="listaPorVencer"></div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th style="text-align: right;">Precio</th>
            <th style="text-align: center;">Stock</th>
            <th style="text-align: center;">Stock M√≠n.</th>
            <th style="text-align: center;">Vence</th>
            <th>Proveedor</th>
            <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>

        <tbody id="tablaProductos">
          <tr>
            <td colspan="9" class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <h3>No hay productos registrados</h3>
              <p>¬°Agrega tu primer producto para comenzar!</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let productos = [];
    let editandoId = null;

    // ‚úÖ Config: alerta si faltan X d√≠as
    const DIAS_AVISO = 30;

    // ‚úÖ Evitar spam de alert en cada guardado: recordamos √∫ltimo aviso
    let lastAlertKey = null;

    // ‚úÖ AUTOCARGA
    window.onload = function () {
      cargarDatos();
      actualizarTabla();
      actualizarEstadisticas();
      revisarVencimientos(false);     // no alert fuerte al abrir si no quer√©s
      actualizarPanelVencimientos();
    };

    // ‚úÖ PWA Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }

    function cargarDatos() {
      try {
        const datosGuardados = localStorage.getItem('inventarioSuplementos');
        productos = datosGuardados ? JSON.parse(datosGuardados) : [];
        if (!Array.isArray(productos)) productos = [];
      } catch (e) {
        productos = [];
      }
    }

    function guardarDatos() {
      localStorage.setItem('inventarioSuplementos', JSON.stringify(productos));
    }

    function toggleFormulario() {
      const form = document.getElementById('formContainer');
      form.classList.toggle('active');
      if (!form.classList.contains('active')) cancelarFormulario();
    }

    function cancelarFormulario() {
      document.getElementById('formContainer').classList.remove('active');
      document.getElementById('formTitle').textContent = 'Nuevo Producto';
      limpiarFormulario();
      editandoId = null;
    }

    function limpiarFormulario() {
      document.getElementById('codigo').value = '';
      document.getElementById('nombre').value = '';
      document.getElementById('categoria').value = '';
      document.getElementById('precio').value = '';
      document.getElementById('stock').value = '';
      document.getElementById('stockMinimo').value = '5';
      document.getElementById('proveedor').value = '';
      document.getElementById('vence').value = '';
    }

    // =========================
    // ‚úÖ FECHAS (ARREGLADO)
    // =========================

    // acepta: "dd/mm/yyyy", "dd-mm-yyyy", "ddmmyyyy", "yyyy-mm-dd"
    function parseFechaVencimiento(input) {
      if (!input) return null;
      let s = String(input).trim();
      if (!s) return null;

      // yyyy-mm-dd
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const [yy, mm, dd] = s.split('-').map(Number);
        return fechaLocal(yy, mm, dd);
      }

      // dd/mm/yyyy o dd-mm-yyyy
      if (/^\d{2}[\/\-]\d{2}[\/\-]\d{4}$/.test(s)) {
        const parts = s.split(/[\/\-]/).map(Number);
        const dd = parts[0], mm = parts[1], yy = parts[2];
        return fechaLocal(yy, mm, dd);
      }

      // ddmmyyyy (ej: 12012026)
      if (/^\d{8}$/.test(s)) {
        const dd = Number(s.slice(0,2));
        const mm = Number(s.slice(2,4));
        const yy = Number(s.slice(4,8));
        return fechaLocal(yy, mm, dd);
      }

      return null;
    }

    // crea fecha en local (sin problemas de zona horaria)
    function fechaLocal(yy, mm, dd) {
      if (!yy || !mm || !dd) return null;
      const d = new Date(yy, mm - 1, dd);
      // validar que no se "autocorrija" (ej 32/13/2026)
      if (d.getFullYear() !== yy || (d.getMonth()+1) !== mm || d.getDate() !== dd) return null;
      // normalizar a medianoche
      d.setHours(0,0,0,0);
      return d;
    }

    function hoyLocal() {
      const h = new Date();
      h.setHours(0,0,0,0);
      return h;
    }

    function diasParaVencer(fechaVence) {
      const hoy = hoyLocal();
      const ms = fechaVence.getTime() - hoy.getTime();
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    }

    function formatearFechaDDMMYYYY(dateObj) {
      const dd = String(dateObj.getDate()).padStart(2,'0');
      const mm = String(dateObj.getMonth()+1).padStart(2,'0');
      const yy = dateObj.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    // =========================
    // ‚úÖ CRUD
    // =========================

    function guardarProducto() {
      const nombre = document.getElementById('nombre').value.trim();
      const precio = document.getElementById('precio').value;
      const stock = document.getElementById('stock').value;

      if (!nombre || !precio || !stock) {
        alert('Por favor completa los campos obligatorios: Nombre, Precio y Stock');
        return;
      }

      // ‚úÖ vencimiento: si lo ponen, lo normalizamos a dd/mm/yyyy
      const venceInput = document.getElementById('vence').value.trim();
      let venceNormal = '';
      if (venceInput) {
        const fv = parseFechaVencimiento(venceInput);
        if (!fv) {
          alert("Fecha de vencimiento inv√°lida. Usa dd/mm/aaaa o ddmmaaaa (ej: 12012026).");
          return;
        }
        venceNormal = formatearFechaDDMMYYYY(fv);
      }

      const producto = {
        id: editandoId || Date.now(),
        codigo: document.getElementById('codigo').value.trim() || '',
        nombre: nombre,
        categoria: document.getElementById('categoria').value || '',
        precio: parseFloat(precio),
        stock: parseInt(stock),
        stockMinimo: parseInt(document.getElementById('stockMinimo').value) || 5,
        proveedor: document.getElementById('proveedor').value.trim() || '',
        vence: venceNormal,
        fechaActualizacion: new Date().toLocaleDateString()
      };

      if (editandoId) {
        const index = productos.findIndex(p => p.id === editandoId);
        productos[index] = producto;
      } else {
        productos.push(producto);
      }

      guardarDatos();
      actualizarTabla();
      actualizarEstadisticas();

      // ‚úÖ revisar vencimientos (con alerta controlada)
      revisarVencimientos(true);
      actualizarPanelVencimientos();

      cancelarFormulario();
    }

    function editarProducto(id) {
      const producto = productos.find(p => p.id === id);
      if (!producto) return;

      document.getElementById('codigo').value = producto.codigo || '';
      document.getElementById('nombre').value = producto.nombre || '';
      document.getElementById('categoria').value = producto.categoria || '';
      document.getElementById('precio').value = producto.precio ?? '';
      document.getElementById('stock').value = producto.stock ?? '';
      document.getElementById('stockMinimo').value = producto.stockMinimo ?? 5;
      document.getElementById('proveedor').value = producto.proveedor || '';
      document.getElementById('vence').value = producto.vence || '';

      editandoId = id;
      document.getElementById('formTitle').textContent = 'Editar Producto';
      document.getElementById('formContainer').classList.add('active');
    }

    function eliminarProducto(id) {
      if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
        productos = productos.filter(p => p.id !== id);
        guardarDatos();
        actualizarTabla();
        actualizarEstadisticas();
        revisarVencimientos(false);
        actualizarPanelVencimientos();
      }
    }

    function ajustarStock(id, cantidad) {
      const producto = productos.find(p => p.id === id);
      if (producto) {
        producto.stock = Math.max(0, (Number(producto.stock) || 0) + cantidad);
        producto.fechaActualizacion = new Date().toLocaleDateString();
        guardarDatos();
        actualizarTabla();
        actualizarEstadisticas();
        revisarVencimientos(false);
        actualizarPanelVencimientos();
      }
    }

    function filtrarProductos() {
      const busqueda = document.getElementById('busqueda').value.toLowerCase();
      const categoria = document.getElementById('filtroCategoria').value;

      const productosFiltrados = productos.filter(p => {
        const coincideBusqueda =
          (p.nombre || '').toLowerCase().includes(busqueda) ||
          (p.codigo || '').toLowerCase().includes(busqueda);

        const coincideCategoria = categoria === 'todos' || p.categoria === categoria;
        return coincideBusqueda && coincideCategoria;
      });

      actualizarTabla(productosFiltrados);
    }

    function estadoVencimiento(p) {
      const fv = parseFechaVencimiento(p.vence);
      if (!fv) return { clase: '', dias: null, tipo: 'sin' };

      const d = diasParaVencer(fv);

      if (d < 0) return { clase: 'vencido', dias: d, tipo: 'vencido' };
      if (d <= DIAS_AVISO) return { clase: 'por-vencer', dias: d, tipo: 'por' };
      return { clase: '', dias: d, tipo: 'ok' };
    }

    function actualizarTabla(productosMostrar = productos) {
      const tbody = document.getElementById('tablaProductos');

      if (!productosMostrar || productosMostrar.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <h3>No hay productos registrados</h3>
              <p>¬°Agrega tu primer producto para comenzar!</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = productosMostrar.map(p => {
        const st = estadoVencimiento(p);
        const claseStock = Number(p.stock || 0) <= Number(p.stockMinimo || 5) ? 'stock-bajo' : '';
        const claseFila = [claseStock, st.clase].filter(Boolean).join(' ');

        return `
          <tr class="${claseFila}">
            <td>${p.codigo || ''}</td>
            <td><strong>${p.nombre || ''}</strong></td>
            <td><span class="categoria-badge">${p.categoria || ''}</span></td>
            <td style="text-align: right;">‚Ç°${Number(p.precio || 0).toFixed(2)}</td>
            <td>
              <div class="stock-controls">
                <button class="stock-btn minus" onclick="ajustarStock(${p.id}, -1)">-</button>
                <span class="stock-value">${Number(p.stock || 0)}</span>
                <button class="stock-btn plus" onclick="ajustarStock(${p.id}, 1)">+</button>
              </div>
            </td>
            <td style="text-align: center;">${Number(p.stockMinimo || 5)}</td>
            <td style="text-align:center;">${p.vence ? p.vence : '-'}</td>
            <td>${p.proveedor || ''}</td>
            <td>
              <div class="action-btns">
                <button class="icon-btn edit" onclick="editarProducto(${p.id})" title="Editar">‚úèÔ∏è</button>
                <button class="icon-btn delete" onclick="eliminarProducto(${p.id})" title="Eliminar">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function actualizarEstadisticas() {
      document.getElementById('totalProductos').textContent = productos.length;

      const valor = productos.reduce((total, p) => {
        return total + (Number(p.precio || 0) * Number(p.stock || 0));
      }, 0);

      document.getElementById('valorInventario').textContent = `‚Ç°${valor.toFixed(2)}`;

      const stockBajo = productos.filter(p => Number(p.stock || 0) <= Number(p.stockMinimo || 5)).length;
      document.getElementById('stockBajo').textContent = stockBajo;
    }

    // =========================
    // ‚úÖ VENCIMIENTOS: panel + alert correcto
    // =========================

    function revisarVencimientos(mostrarAlert) {
      // SOLO productos con fecha v√°lida
      const items = productos.map(p => {
        const fv = parseFechaVencimiento(p.vence);
        if (!fv) return null;
        const d = diasParaVencer(fv);
        return { p, dias: d };
      }).filter(Boolean);

      const vencidos = items.filter(x => x.dias < 0);
      const porVencer = items.filter(x => x.dias >= 0 && x.dias <= DIAS_AVISO);

      // ‚úÖ Alert SOLO si hay algo vencido o por vencer
      if (!mostrarAlert) return;

      if (vencidos.length === 0 && porVencer.length === 0) return;

      // ‚úÖ Evitar que se repita la misma alerta siempre
      const key = `${vencidos.map(v=>v.p.id).join(',')}|${porVencer.map(v=>v.p.id).join(',')}`;
      if (key === lastAlertKey) return;
      lastAlertKey = key;

      let msg = `‚ö†Ô∏è Vencimientos:\n\n`;
      if (vencidos.length) {
        msg += `üî¥ Vencidos (${vencidos.length}):\n`;
        vencidos.slice(0,5).forEach(x => {
          msg += `- ${x.p.nombre} (${x.p.codigo}) venci√≥ el ${x.p.vence}\n`;
        });
        if (vencidos.length > 5) msg += `... y ${vencidos.length - 5} m√°s\n`;
        msg += `\n`;
      }

      if (porVencer.length) {
        msg += `üü° Por vencer (‚â§ ${DIAS_AVISO} d√≠as) (${porVencer.length}):\n`;
        porVencer.slice(0,5).forEach(x => {
          msg += `- ${x.p.nombre} (${x.p.codigo}) vence el ${x.p.vence} (en ${x.dias} d√≠a(s))\n`;
        });
        if (porVencer.length > 5) msg += `... y ${porVencer.length - 5} m√°s\n`;
      }

      alert(msg);
    }

    function actualizarPanelVencimientos() {
      const panel = document.getElementById("alertPanel");
      const meta = document.getElementById("alertMeta");
      const listaVencidos = document.getElementById("listaVencidos");
      const listaPorVencer = document.getElementById("listaPorVencer");

      const vencidos = [];
      const porVencer = [];

      for (const p of productos) {
        const f = parseFechaVencimiento(p.vence);
        if (!f) continue;

        const d = diasParaVencer(f);

        const itemHTML = `
          <div class="alert-item">
            <strong>${p.nombre || ""} <span style="color:#6b7280;">(${p.codigo || ""})</span></strong>
            <small>Vence: ${p.vence || "-"} ‚Ä¢ ${d < 0 ? "Hace " + Math.abs(d) + " d√≠a(s)" : "En " + d + " d√≠a(s)"}</small>
          </div>
        `;

        if (d < 0) vencidos.push(itemHTML);
        else if (d <= DIAS_AVISO) porVencer.push(itemHTML);
      }

      listaVencidos.innerHTML = vencidos.length
        ? vencidos.join("")
        : `<div class="alert-item"><small>No hay vencidos ‚úÖ</small></div>`;

      listaPorVencer.innerHTML = porVencer.length
        ? porVencer.join("")
        : `<div class="alert-item"><small>No hay productos por vencer ‚úÖ</small></div>`;

      const total = vencidos.length + porVencer.length;

      if (total > 0) {
        panel.style.display = "block";
        meta.textContent = `Vencidos: ${vencidos.length} ‚Ä¢ Por vencer: ${porVencer.length} ‚Ä¢ Aviso: ${DIAS_AVISO} d√≠as`;
      } else {
        panel.style.display = "none";
      }
    }

    // =========================
    // ‚úÖ EXCEL / JSON
    // =========================

    function exportarExcel() {
      if (productos.length === 0) {
        alert('No hay productos para exportar');
        return;
      }

      const datosExportar = productos.map(p => ({
        'C√≥digo': p.codigo || '',
        'Nombre': p.nombre || '',
        'Categor√≠a': p.categoria || '',
        'Precio': Number(p.precio || 0),
        'Stock': Number(p.stock || 0),
        'Stock M√≠nimo': Number(p.stockMinimo || 5),
        'Vence': p.vence || '',
        'Proveedor': p.proveedor || '',
        '√öltima Actualizaci√≥n': p.fechaActualizacion || ''
      }));

      const ws = XLSX.utils.json_to_sheet(datosExportar);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
      XLSX.writeFile(wb, `inventario_suplementos_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
    }

    function importarExcel(e) {
      const archivo = e.target.files[0];
      if (!archivo) return;

      const reader = new FileReader();
      reader.onload = function (evento) {
        const datos = new Uint8Array(evento.target.result);
        const workbook = XLSX.read(datos, { type: 'array' });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(hoja);

        const productosImportados = json.map(item => {
          // normalizamos "Vence"
          const v = (item['Vence'] || item['Vencimiento'] || item['Fecha de vencimiento'] || '').toString().trim();
          let venceNormal = '';
          if (v) {
            const fv = parseFechaVencimiento(v);
            if (fv) venceNormal = formatearFechaDDMMYYYY(fv);
          }

          return {
            id: Date.now() + Math.random(),
            codigo: (item['C√≥digo'] || '').toString(),
            nombre: (item['Nombre'] || '').toString(),
            categoria: (item['Categor√≠a'] || '').toString(),
            precio: parseFloat(item['Precio']) || 0,
            stock: parseInt(item['Stock']) || 0,
            stockMinimo: parseInt(item['Stock M√≠nimo']) || 5,
            vence: venceNormal,
            proveedor: (item['Proveedor'] || '').toString(),
            fechaActualizacion: new Date().toLocaleDateString()
          };
        });

        productos = [...productos, ...productosImportados];
        guardarDatos();
        actualizarTabla();
        actualizarEstadisticas();
        revisarVencimientos(false);
        actualizarPanelVencimientos();

        alert(`${productosImportados.length} productos importados exitosamente`);
      };

      reader.readAsArrayBuffer(archivo);
      e.target.value = '';
    }

    function guardarJSON() {
      const data = { productos, fecha: new Date().toISOString() };

      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `inventario_suplementos_${yyyy}-${mm}-${dd}.json`;
      a.click();

      URL.revokeObjectURL(url);
    }

    function cargarJSON(e) {
      const archivo = e.target.files[0];
      if (!archivo) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);

          if (!data.productos || !Array.isArray(data.productos)) {
            alert("Archivo inv√°lido: no contiene 'productos' correctamente.");
            return;
          }

          // normalizar vencimientos por si vienen raros
          productos = data.productos.map(p => {
            const v = (p.vence || p.Vence || '').toString().trim();
            let venceNormal = '';
            if (v) {
              const fv = parseFechaVencimiento(v);
              if (fv) venceNormal = formatearFechaDDMMYYYY(fv);
            }
            return {
              ...p,
              vence: venceNormal
            };
          });

          guardarDatos();
          actualizarTabla();
          actualizarEstadisticas();
          revisarVencimientos(false);
          actualizarPanelVencimientos();

          alert("Respaldo restaurado ‚úÖ");
        } catch (err) {
          alert("No se pudo cargar el archivo JSON (formato inv√°lido).");
        }
      };

      reader.readAsText(archivo);
      e.target.value = "";
    }
  </script>
</body>
</html>

