<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario + Cr√©ditos - Suplementos</title>

  <!-- ‚úÖ PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: white;
      padding: 26px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 18px;
    }

    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .header h1 { color: #111827; font-size: 2em; margin-bottom: 6px; }
    .header p { color: #6b7280; font-size: 1.02em; }

    .tabs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .tab-btn{
      padding: 10px 14px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      background: #fff;
      cursor:pointer;
      font-weight: 800;
      color:#111827;
      transition: .2s;
    }
    .tab-btn.active{
      border-color:#667eea;
      background:#eef2ff;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: white;
      padding: 18px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-card h3 { color: #6b7280; font-size: 0.9em; margin-bottom: 8px; }
    .stat-card .value { font-size: 1.8em; font-weight: 900; }
    .stat-card .icon { font-size: 2.6em; opacity: 0.25; }

    .controls {
      background: white;
      padding: 18px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 14px;
    }

    .btn {
      padding: 11px 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 800;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select:none;
    }

    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-1px); }

    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }

    .btn-info { background: #3b82f6; color: white; }
    .btn-info:hover { background: #2563eb; }

    .btn-gray { background: #6b7280; color: white; }
    .btn-gray:hover { background: #4b5563; }

    .search-filter { display: flex; flex-wrap: wrap; gap: 12px; }

    .search-box { flex: 1; min-width: 250px; position: relative; }

    .search-box input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1em;
      transition: border-color 0.2s;
    }

    .search-box input:focus { outline: none; border-color: #667eea; }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    select, input[type="number"], input[type="text"] {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1em;
      background: white;
    }
    select:focus, input:focus { outline:none; border-color:#667eea; }

    .form-container {
      background: white;
      padding: 18px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      display: none;
    }
    .form-container.active { display:block; }
    .form-container h2 { margin-bottom: 12px; color:#111827; }

    .form-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .hint{
      font-size: 0.92em;
      color:#6b7280;
      font-weight: 700;
      margin: 6px 0 12px 0;
    }

    .table-container{
      background:white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    table{ width:100%; border-collapse:collapse; }
    thead{ background:#667eea; color:white; }
    thead th{ padding: 14px; text-align:left; font-weight: 800; }
    tbody td{ padding: 13px; border-bottom: 1px solid #eef2f7; }
    tbody tr:hover{ background:#f9fafb; }

    tbody tr.stock-bajo { background: #fee2e2; }
    tbody tr.stock-bajo:hover { background: #fecaca; }

    tbody tr.vencido { background: #ffe4e6 !important; }
    tbody tr.por-vencer { background: #fef3c7 !important; }

    .categoria-badge{
      display:inline-block;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 0.85em;
      font-weight: 900;
      background: #ddd6fe;
      color:#5b21b6;
    }

    .stock-controls{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    .stock-btn{
      width: 32px; height:32px;
      border:none;
      border-radius: 9px;
      cursor:pointer;
      font-weight: 900;
      font-size: 1.2em;
      transition:.15s;
    }
    .stock-btn.minus{ background:#ef4444; color:#fff; }
    .stock-btn.plus{ background:#10b981; color:#fff; }
    .stock-btn:hover{ transform:scale(1.07); }
    .stock-value{ font-weight: 900; min-width: 40px; text-align:center; }

    .action-btns{ display:flex; gap: 10px; justify-content:center; }
    .icon-btn{
      background:none;
      border:none;
      cursor:pointer;
      font-size: 1.1em;
      transition:.15s;
    }
    .icon-btn:hover{ transform: scale(1.15); }
    .icon-btn.edit{ color:#3b82f6; }
    .icon-btn.delete{ color:#ef4444; }

    .empty-state{
      text-align:center;
      padding: 55px 20px;
      color:#9ca3af;
    }
    .empty-state svg{ width: 95px; height:95px; opacity: .3; margin-bottom: 10px; }

    /* ‚úÖ Panel vencimientos */
    .alert-panel{
      background:white;
      border-radius: 15px;
      padding: 18px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      display:none;
    }
    .alert-head{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .alert-head h2{ font-size: 1.15em; color:#111827; }
    .alert-meta{ color:#6b7280; font-weight: 900; }
    .alert-cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .alert-box{
      border:2px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
    }
    .alert-expired{ border-color:#ef4444; background:#fff1f2; }
    .alert-soon{ border-color:#f59e0b; background:#fffbeb; }
    .alert-box h3{ margin-bottom: 10px; color:#111827; }
    .alert-list{
      display:flex;
      flex-direction:column;
      gap: 8px;
      max-height: 200px;
      overflow:auto;
      padding-right: 6px;
    }
    .alert-item{
      background: rgba(255,255,255,0.85);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(0,0,0,0.06);
    }
    .alert-item strong{ display:block; margin-bottom: 4px; }
    .alert-item small{ color:#374151; font-weight: 900; }

    /* ‚úÖ Cr√©ditos */
    .two-cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .card{
      background:white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 16px;
      margin-bottom: 12px;
    }
    .card h2{ font-size: 1.15em; color:#111827; margin-bottom: 10px; }
    .mini{
      font-size: 0.92em;
      color:#6b7280;
      font-weight: 800;
      margin-bottom: 10px;
    }
    .line{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-bottom: 10px;
    }
    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: .9em;
      background: #eef2ff;
      color: #3730a3;
    }
    .pill.red{ background:#fee2e2; color:#991b1b; }
    .pill.green{ background:#dcfce7; color:#166534; }
    .pill.yellow{ background:#fef3c7; color:#92400e; }

    .items-table td, .items-table th { padding: 10px; }
    .items-table thead{ background:#111827; }
    .right{ text-align:right; }
    .center{ text-align:center; }

    @media (max-width: 900px){
      .two-cols{ grid-template-columns: 1fr; }
      .alert-cols{ grid-template-columns: 1fr; }
      .table-container{ overflow-x:auto; }
      table{ min-width: 1050px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <div>
          <h1>üì¶ Inventario + Cr√©ditos (Suplementos)</h1>
          <p>Inventario con vencimientos + ventas a clientes con abonos ‚úÖ</p>
        </div>

        <div class="tabs">
          <button class="tab-btn active" id="tabInventario" onclick="cambiarVista('inventario')">üì¶ Inventario</button>
          <button class="tab-btn" id="tabCreditos" onclick="cambiarVista('creditos')">üßæ Cr√©ditos</button>
        </div>
      </div>
    </div>

    <!-- =========================
         VISTA INVENTARIO
    ========================== -->
    <div id="vistaInventario">
      <div class="stats">
        <div class="stat-card">
          <div>
            <h3>Total Productos</h3>
            <div class="value" style="color:#667eea;" id="totalProductos">0</div>
          </div>
          <div class="icon">üì¶</div>
        </div>

        <div class="stat-card">
          <div>
            <h3>Valor Inventario</h3>
            <div class="value" style="color:#10b981;" id="valorInventario">‚Ç°0.00</div>
          </div>
          <div class="icon">üí∞</div>
        </div>

        <div class="stat-card">
          <div>
            <h3>Stock Bajo</h3>
            <div class="value" style="color:#ef4444;" id="stockBajo">0</div>
          </div>
          <div class="icon">‚ö†Ô∏è</div>
        </div>

        <div class="stat-card">
          <div>
            <h3>Categor√≠as</h3>
            <div class="value" style="color:#8b5cf6;" id="totalCategorias">7</div>
          </div>
          <div class="icon">üìÇ</div>
        </div>
      </div>

      <div class="controls">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="toggleFormulario()">‚ûï Agregar Producto</button>
          <button class="btn btn-success" onclick="exportarExcel()">‚¨áÔ∏è Exportar Excel</button>

          <label class="btn btn-info">
            ‚¨ÜÔ∏è Importar Excel
            <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none;" onchange="importarExcel(event)">
          </label>

          <button class="btn btn-success" onclick="guardarJSON()">üíæ Respaldo (JSON)</button>

          <label class="btn btn-info">
            üìÇ Restaurar (JSON)
            <input type="file" id="importJSON" accept=".json" style="display:none;" onchange="cargarJSON(event)">
          </label>
        </div>

        <div class="search-filter">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" id="busqueda" placeholder="Buscar por nombre o c√≥digo..." oninput="filtrarProductos()">
          </div>

          <select id="filtroCategoria" onchange="filtrarProductos()">
            <option value="todos">Todas las categor√≠as</option>
            <option value="Prote√≠nas">Prote√≠nas</option>
            <option value="Vitaminas">Vitaminas</option>
            <option value="Amino√°cidos">Amino√°cidos</option>
            <option value="Pre-Entreno">Pre-Entreno</option>
            <option value="Creatina">Creatina</option>
            <option value="Quemadores">Quemadores</option>
            <option value="Otros">Otros</option>
          </select>
        </div>
      </div>

      <div class="form-container" id="formContainer">
        <h2 id="formTitle">Nuevo Producto</h2>

        <div class="form-grid">
          <input type="text" id="codigo" placeholder="C√≥digo">
          <input type="text" id="nombre" placeholder="Nombre *" required>

          <select id="categoria">
            <option value="">Seleccionar categor√≠a</option>
            <option value="Prote√≠nas">Prote√≠nas</option>
            <option value="Vitaminas">Vitaminas</option>
            <option value="Amino√°cidos">Amino√°cidos</option>
            <option value="Pre-Entreno">Pre-Entreno</option>
            <option value="Creatina">Creatina</option>
            <option value="Quemadores">Quemadores</option>
            <option value="Otros">Otros</option>
          </select>

          <input type="number" id="precio" placeholder="Precio *" step="0.01" required>
          <input type="number" id="stock" placeholder="Stock *" required>
          <input type="number" id="stockMinimo" placeholder="Stock M√≠nimo" value="5">
          <input type="text" id="proveedor" placeholder="Proveedor">
          <input type="text" id="vence" placeholder="Vence (dd/mm/aaaa o ddmmaaaa)">
        </div>

        <div class="hint">
          Ej: <b>01/12/2026</b> o <b>12012026</b> (= 12/01/2026). Si lo dej√°s vac√≠o, no se eval√∫a.
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="guardarProducto()">üíæ Guardar</button>
          <button class="btn btn-gray" onclick="cancelarFormulario()">‚ùå Cancelar</button>
        </div>
      </div>

      <div class="alert-panel" id="alertPanel">
        <div class="alert-head">
          <h2>üìÖ Vencimientos</h2>
          <div class="alert-meta" id="alertMeta"></div>
        </div>

        <div class="alert-cols">
          <div class="alert-box alert-expired">
            <h3>üî¥ Vencidos</h3>
            <div class="alert-list" id="listaVencidos"></div>
          </div>

          <div class="alert-box alert-soon">
            <h3>üü° Prontos a vencer</h3>
            <div class="alert-list" id="listaPorVencer"></div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th class="right">Precio</th>
              <th class="center">Stock</th>
              <th class="center">Stock M√≠n.</th>
              <th class="center">Vence</th>
              <th>Proveedor</th>
              <th class="center">Acciones</th>
            </tr>
          </thead>

          <tbody id="tablaProductos">
            <tr>
              <td colspan="9" class="empty-state">
                <h3>No hay productos registrados</h3>
                <p>¬°Agrega tu primer producto para comenzar!</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- =========================
         VISTA CR√âDITOS
    ========================== -->
    <div id="vistaCreditos" style="display:none;">
      <div class="stats">
        <div class="stat-card">
          <div>
            <h3>Clientes</h3>
            <div class="value" style="color:#667eea;" id="totalClientes">0</div>
          </div>
          <div class="icon">üë§</div>
        </div>

        <div class="stat-card">
          <div>
            <h3>Ventas (Cr√©dito)</h3>
            <div class="value" style="color:#3b82f6;" id="totalVentas">0</div>
          </div>
          <div class="icon">üßæ</div>
        </div>

        <div class="stat-card">
          <div>
            <h3>Deuda Total</h3>
            <div class="value" style="color:#ef4444;" id="deudaTotal">‚Ç°0.00</div>
          </div>
          <div class="icon">üí≥</div>
        </div>

        <div class="stat-card">
          <div>
            <h3>Abonos Totales</h3>
            <div class="value" style="color:#10b981;" id="abonosTotal">‚Ç°0.00</div>
          </div>
          <div class="icon">‚úÖ</div>
        </div>
      </div>

      <div class="controls">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="toggleVenta()">‚ûï Nueva Venta / Cr√©dito</button>
          <button class="btn btn-success" onclick="exportarExcel()">‚¨áÔ∏è Exportar Excel</button>
          <button class="btn btn-success" onclick="guardarJSON()">üíæ Respaldo (JSON)</button>
          <label class="btn btn-info">
            üìÇ Restaurar (JSON)
            <input type="file" id="importJSON2" accept=".json" style="display:none;" onchange="cargarJSON(event)">
          </label>
        </div>

        <div class="search-filter">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" id="busquedaVentas" placeholder="Buscar por cliente..." oninput="filtrarVentas()">
          </div>

          <select id="filtroEstadoVenta" onchange="filtrarVentas()">
            <option value="todas">Todas</option>
            <option value="pendiente">Pendientes</option>
            <option value="pagada">Pagadas</option>
          </select>
        </div>
      </div>

      <!-- Form Venta -->
      <div class="form-container" id="ventaContainer">
        <h2>üßæ Nueva Venta / Cr√©dito</h2>

        <div class="two-cols">
          <div>
            <div class="line">
              <select id="clienteSelect" style="min-width:260px;"></select>
              <button class="btn btn-info" onclick="toggleNuevoCliente()">‚ûï Cliente</button>
            </div>

            <div id="nuevoClienteBox" style="display:none;">
              <div class="form-grid">
                <input type="text" id="clienteNombre" placeholder="Nombre del cliente *">
                <input type="text" id="clienteTelefono" placeholder="Tel√©fono (opcional)">
              </div>
              <div class="btn-group">
                <button class="btn btn-success" onclick="guardarCliente()">‚úÖ Guardar Cliente</button>
                <button class="btn btn-gray" onclick="toggleNuevoCliente()">‚ùå Cancelar</button>
              </div>
            </div>

            <div class="mini">Seleccion√° productos y cantidades </div>
            <div class="line">
              <select id="productoVentaSelect" style="min-width:260px;"></select>
              <input type="number" id="cantidadVenta" placeholder="Cantidad" min="1" style="width:140px;">
              <button class="btn btn-primary" onclick="agregarItemVenta()">‚ûï Agregar</button>
            </div>

            <div class="hint">Si no hay  Stock, no deja agregar.</div>
          </div>

          <div>
            <div class="card" style="margin-bottom:0;">
              <h2>Resumen</h2>
              <div class="line">
                <span class="pill" id="ventaItemsCount">Items: 0</span>
                <span class="pill green" id="ventaTotal">Total: ‚Ç°0.00</span>
                <span class="pill yellow" id="ventaAbono">Abono: ‚Ç°0.00</span>
                <span class="pill red" id="ventaSaldo">Saldo: ‚Ç°0.00</span>
              </div>
              <div class="form-grid">
                <input type="number" id="abonoInicial" placeholder="Abono inicial (opcional)" step="0.01" min="0">
                <input type="text" id="notaVenta" placeholder="Nota (opcional)">
              </div>
              <div class="btn-group">
                <button class="btn btn-success" onclick="confirmarVenta()">‚úÖ Guardar Venta</button>
                <button class="btn btn-gray" onclick="cancelarVenta()">‚ùå Cancelar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="table-container">
          <table class="items-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th class="center">Cant.</th>
                <th class="right">Precio</th>
                <th class="right">Subtotal</th>
                <th class="center">Quitar</th>
              </tr>
            </thead>
            <tbody id="ventaItemsBody">
              <tr>
                <td colspan="5" class="empty-state">
                  <h3>Sin productos</h3>
                  <p>Agreg√° productos a la venta.</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Lista ventas -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Productos</th>
              <th class="right">Total</th>
              <th class="right">Abonado</th>
              <th class="right">Saldo</th>
              <th class="center">Estado</th>
              <th class="center">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaVentas">
            <tr>
              <td colspan="8" class="empty-state">
                <h3>No hay ventas</h3>
                <p>Cre√° tu primera venta a cr√©dito.</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Historial abonos -->
      <div class="card" style="margin-top:12px;">
        <h2>üìå Historial de Abonos (√∫ltimos 20)</h2>
        <div class="mini">Se registra cada abono con fecha, venta y cliente.</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Venta</th>
                <th class="right">Monto</th>
              </tr>
            </thead>
            <tbody id="tablaAbonos">
              <tr>
                <td colspan="4" class="empty-state">
                  <h3>Sin abonos</h3>
                  <p>A√∫n no registr√°s pagos.</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

<script>
  // =========================
  // ‚úÖ DATA (LocalStorage) - FIX
  // =========================
  const STORAGE_KEY = "appInventarioSuplementos_v2";
  const OLD_KEY = "inventarioSuplementos";

  let productos = [];
  let clientes = [];
  let ventas = [];
  let abonos = [];

  let editandoId = null;

  // ‚úÖ Config: alerta de vencimiento
  const DIAS_AVISO = 30;
  let lastAlertKey = null;

  // venta actual (en memoria)
  let ventaActual = {
    clienteId: null,
    items: [],
    abonoInicial: 0,
    nota: ""
  };

  // ‚úÖ AUTOCARGA
  window.onload = function () {
    cargarDatos();
    refrescarTodo();
  };

  // ‚úÖ PWA Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(() => {});
    });
  }

  function cargarDatos() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const data = JSON.parse(raw);
        productos = Array.isArray(data.productos) ? data.productos : [];
        clientes  = Array.isArray(data.clientes) ? data.clientes : [];
        ventas    = Array.isArray(data.ventas) ? data.ventas : [];
        abonos    = Array.isArray(data.abonos) ? data.abonos : [];
        return;
      }
    } catch (e) {}

    // migrar versi√≥n vieja
    try {
      const old = localStorage.getItem(OLD_KEY);
      if (old) {
        const arr = JSON.parse(old);
        productos = Array.isArray(arr) ? arr : [];
        clientes = [];
        ventas = [];
        abonos = [];
        guardarDatos();
        return;
      }
    } catch (e) {}

    productos = [];
    clientes = [];
    ventas = [];
    abonos = [];
  }

  function guardarDatos() {
    const data = { productos, clientes, ventas, abonos, updatedAt: new Date().toISOString() };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  // =========================
  // ‚úÖ UTIL FECHAS
  // =========================
  function parseFechaVencimiento(input) {
    if (!input) return null;
    let s = String(input).trim();
    if (!s) return null;

    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
      const [yy, mm, dd] = s.split('-').map(Number);
      return fechaLocal(yy, mm, dd);
    }

    if (/^\d{2}[\/\-]\d{2}[\/\-]\d{4}$/.test(s)) {
      const parts = s.split(/[\/\-]/).map(Number);
      return fechaLocal(parts[2], parts[1], parts[0]);
    }

    if (/^\d{8}$/.test(s)) {
      const dd = Number(s.slice(0,2));
      const mm = Number(s.slice(2,4));
      const yy = Number(s.slice(4,8));
      return fechaLocal(yy, mm, dd);
    }

    return null;
  }

  function fechaLocal(yy, mm, dd) {
    if (!yy || !mm || !dd) return null;
    const d = new Date(yy, mm - 1, dd);
    if (d.getFullYear() !== yy || (d.getMonth()+1) !== mm || d.getDate() !== dd) return null;
    d.setHours(0,0,0,0);
    return d;
  }

  function hoyLocal() {
    const h = new Date();
    h.setHours(0,0,0,0);
    return h;
  }

  function diasParaVencer(fechaVence) {
    const hoy = hoyLocal();
    const ms = fechaVence.getTime() - hoy.getTime();
    return Math.floor(ms / (1000 * 60 * 60 * 24));
  }

  function formatearFechaDDMMYYYY(dateObj) {
    const dd = String(dateObj.getDate()).padStart(2,'0');
    const mm = String(dateObj.getMonth()+1).padStart(2,'0');
    const yy = dateObj.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function money(n){
    return `‚Ç°${Number(n || 0).toFixed(2)}`;
  }

  // =========================
  // ‚úÖ VISTAS
  // =========================
  function cambiarVista(v) {
    const inv = document.getElementById("vistaInventario");
    const cre = document.getElementById("vistaCreditos");
    const tInv = document.getElementById("tabInventario");
    const tCre = document.getElementById("tabCreditos");

    if (v === "creditos") {
      inv.style.display = "none";
      cre.style.display = "block";
      tInv.classList.remove("active");
      tCre.classList.add("active");
    } else {
      inv.style.display = "block";
      cre.style.display = "none";
      tInv.classList.add("active");
      tCre.classList.remove("active");
    }
  }

  // =========================
  // ‚úÖ INVENTARIO CRUD
  // =========================
  function toggleFormulario() {
    const form = document.getElementById('formContainer');
    form.classList.toggle('active');
    if (!form.classList.contains('active')) cancelarFormulario();
  }

  function cancelarFormulario() {
    document.getElementById('formContainer').classList.remove('active');
    document.getElementById('formTitle').textContent = 'Nuevo Producto';
    limpiarFormulario();
    editandoId = null;
  }

  function limpiarFormulario() {
    document.getElementById('codigo').value = '';
    document.getElementById('nombre').value = '';
    document.getElementById('categoria').value = '';
    document.getElementById('precio').value = '';
    document.getElementById('stock').value = '';
    document.getElementById('stockMinimo').value = '5';
    document.getElementById('proveedor').value = '';
    document.getElementById('vence').value = '';
  }

  function guardarProducto() {
    const nombre = document.getElementById('nombre').value.trim();
    const precio = document.getElementById('precio').value;
    const stock = document.getElementById('stock').value;

    if (!nombre || !precio || !stock) {
      alert('Completa: Nombre, Precio y Stock');
      return;
    }

    const venceInput = document.getElementById('vence').value.trim();
    let venceNormal = '';
    if (venceInput) {
      const fv = parseFechaVencimiento(venceInput);
      if (!fv) {
        alert("Fecha de vencimiento inv√°lida. Usa dd/mm/aaaa o ddmmaaaa (ej: 12012026).");
        return;
      }
      venceNormal = formatearFechaDDMMYYYY(fv);
    }

    const producto = {
      id: editandoId || Date.now(),
      codigo: document.getElementById('codigo').value.trim() || '',
      nombre,
      categoria: document.getElementById('categoria').value || '',
      precio: parseFloat(precio),
      stock: parseInt(stock),
      stockMinimo: parseInt(document.getElementById('stockMinimo').value) || 5,
      proveedor: document.getElementById('proveedor').value.trim() || '',
      vence: venceNormal,
      fechaActualizacion: new Date().toLocaleDateString()
    };

    if (editandoId) {
      const i = productos.findIndex(p => p.id === editandoId);
      if (i >= 0) productos[i] = producto;
    } else {
      productos.push(producto);
    }

    guardarDatos();
    refrescarTodo();
    cancelarFormulario();
    revisarVencimientos(true);
  }

  function editarProducto(id) {
    const p = productos.find(x => x.id === id);
    if (!p) return;

    document.getElementById('codigo').value = p.codigo || '';
    document.getElementById('nombre').value = p.nombre || '';
    document.getElementById('categoria').value = p.categoria || '';
    document.getElementById('precio').value = p.precio ?? '';
    document.getElementById('stock').value = p.stock ?? '';
    document.getElementById('stockMinimo').value = p.stockMinimo ?? 5;
    document.getElementById('proveedor').value = p.proveedor || '';
    document.getElementById('vence').value = p.vence || '';

    editandoId = id;
    document.getElementById('formTitle').textContent = 'Editar Producto';
    document.getElementById('formContainer').classList.add('active');
  }

  function eliminarProducto(id) {
    if (!confirm("¬øEliminar producto?")) return;
    productos = productos.filter(p => p.id !== id);
    guardarDatos();
    refrescarTodo();
  }

  function ajustarStock(id, cantidad) {
    const p = productos.find(x => x.id === id);
    if (!p) return;
    p.stock = Math.max(0, (Number(p.stock) || 0) + cantidad);
    p.fechaActualizacion = new Date().toLocaleDateString();
    guardarDatos();
    refrescarTodo();
  }

  function filtrarProductos() {
    const busqueda = document.getElementById('busqueda').value.toLowerCase();
    const categoria = document.getElementById('filtroCategoria').value;

    const filtrados = productos.filter(p => {
      const b = (p.nombre || '').toLowerCase().includes(busqueda) || (p.codigo || '').toLowerCase().includes(busqueda);
      const c = (categoria === 'todos') || (p.categoria === categoria);
      return b && c;
    });

    actualizarTablaInventario(filtrados);
  }

  function estadoVencimiento(p) {
    const fv = parseFechaVencimiento(p.vence);
    if (!fv) return { clase: '', tipo: 'sin', dias: null };
    const d = diasParaVencer(fv);
    if (d < 0) return { clase: 'vencido', tipo: 'vencido', dias: d };
    if (d <= DIAS_AVISO) return { clase: 'por-vencer', tipo: 'por', dias: d };
    return { clase: '', tipo: 'ok', dias: d };
  }

  function actualizarTablaInventario(list = productos) {
    const tbody = document.getElementById('tablaProductos');

    if (!list || list.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="9" class="empty-state">
          <h3>No hay productos</h3><p>Agrega productos para comenzar.</p>
        </td></tr>
      `;
      return;
    }

    tbody.innerHTML = list.map(p => {
      const st = estadoVencimiento(p);
      const claseStock = Number(p.stock || 0) <= Number(p.stockMinimo || 5) ? 'stock-bajo' : '';
      const claseFila = [claseStock, st.clase].filter(Boolean).join(' ');

      return `
        <tr class="${claseFila}">
          <td>${p.codigo || ''}</td>
          <td><strong>${p.nombre || ''}</strong></td>
          <td><span class="categoria-badge">${p.categoria || ''}</span></td>
          <td class="right">${money(p.precio)}</td>
          <td class="center">
            <div class="stock-controls">
              <button class="stock-btn minus" onclick="ajustarStock(${p.id}, -1)">-</button>
              <span class="stock-value">${Number(p.stock || 0)}</span>
              <button class="stock-btn plus" onclick="ajustarStock(${p.id}, 1)">+</button>
            </div>
          </td>
          <td class="center">${Number(p.stockMinimo || 5)}</td>
          <td class="center">${p.vence ? p.vence : '-'}</td>
          <td>${p.proveedor || ''}</td>
          <td class="center">
            <div class="action-btns">
              <button class="icon-btn edit" onclick="editarProducto(${p.id})" title="Editar">‚úèÔ∏è</button>
              <button class="icon-btn delete" onclick="eliminarProducto(${p.id})" title="Eliminar">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function actualizarEstadisticasInventario() {
    document.getElementById('totalProductos').textContent = productos.length;

    const valor = productos.reduce((t,p) => t + (Number(p.precio||0)*Number(p.stock||0)), 0);
    document.getElementById('valorInventario').textContent = money(valor);

    const stockBajo = productos.filter(p => Number(p.stock||0) <= Number(p.stockMinimo||5)).length;
    document.getElementById('stockBajo').textContent = stockBajo;
  }

  function revisarVencimientos(mostrarAlert) {
    const items = productos.map(p => {
      const fv = parseFechaVencimiento(p.vence);
      if (!fv) return null;
      return { p, dias: diasParaVencer(fv) };
    }).filter(Boolean);

    const vencidos = items.filter(x => x.dias < 0);
    const porVencer = items.filter(x => x.dias >= 0 && x.dias <= DIAS_AVISO);

    if (!mostrarAlert) return;
    if (vencidos.length === 0 && porVencer.length === 0) return;

    const key = `${vencidos.map(v=>v.p.id).join(',')}|${porVencer.map(v=>v.p.id).join(',')}`;
    if (key === lastAlertKey) return;
    lastAlertKey = key;

    let msg = `‚ö†Ô∏è Vencimientos:\n\n`;
    if (vencidos.length) {
      msg += `üî¥ Vencidos (${vencidos.length}):\n`;
      vencidos.slice(0,6).forEach(x => msg += `- ${x.p.nombre} (${x.p.codigo}) venci√≥ ${x.p.vence}\n`);
      if (vencidos.length > 6) msg += `... y ${vencidos.length - 6} m√°s\n`;
      msg += `\n`;
    }
    if (porVencer.length) {
      msg += `üü° Por vencer (‚â§ ${DIAS_AVISO} d√≠as) (${porVencer.length}):\n`;
      porVencer.slice(0,6).forEach(x => msg += `- ${x.p.nombre} (${x.p.codigo}) vence ${x.p.vence} (en ${x.dias} d√≠a(s))\n`);
      if (porVencer.length > 6) msg += `... y ${porVencer.length - 6} m√°s\n`;
    }
    alert(msg);
  }

  function actualizarPanelVencimientos() {
    const panel = document.getElementById("alertPanel");
    const meta = document.getElementById("alertMeta");
    const listaVencidos = document.getElementById("listaVencidos");
    const listaPorVencer = document.getElementById("listaPorVencer");

    const vencidos = [];
    const porVencer = [];

    for (const p of productos) {
      const f = parseFechaVencimiento(p.vence);
      if (!f) continue;

      const d = diasParaVencer(f);
      const itemHTML = `
        <div class="alert-item">
          <strong>${p.nombre || ""} <span style="color:#6b7280;">(${p.codigo || ""})</span></strong>
          <small>Vence: ${p.vence || "-"} ‚Ä¢ ${d < 0 ? "Hace " + Math.abs(d) + " d√≠a(s)" : "En " + d + " d√≠a(s)"}</small>
        </div>
      `;
      if (d < 0) vencidos.push(itemHTML);
      else if (d <= DIAS_AVISO) porVencer.push(itemHTML);
    }

    listaVencidos.innerHTML = vencidos.length ? vencidos.join("") : `<div class="alert-item"><small>No hay vencidos ‚úÖ</small></div>`;
    listaPorVencer.innerHTML = porVencer.length ? porVencer.join("") : `<div class="alert-item"><small>No hay por vencer ‚úÖ</small></div>`;

    const total = vencidos.length + porVencer.length;

    if (total > 0) {
      panel.style.display = "block";
      meta.textContent = `Vencidos: ${vencidos.length} ‚Ä¢ Por vencer: ${porVencer.length} ‚Ä¢ Aviso: ${DIAS_AVISO} d√≠as`;
    } else {
      panel.style.display = "none";
    }
  }

  // =========================
  // ‚úÖ CLIENTES
  // =========================
  function toggleNuevoCliente(){
    const box = document.getElementById("nuevoClienteBox");
    box.style.display = (box.style.display === "none" || !box.style.display) ? "block" : "none";
    document.getElementById("clienteNombre").value = "";
    document.getElementById("clienteTelefono").value = "";
  }

  function guardarCliente(){
    const nombre = document.getElementById("clienteNombre").value.trim();
    const tel = document.getElementById("clienteTelefono").value.trim();
    if (!nombre){
      alert("Pon√© el nombre del cliente.");
      return;
    }

    const existe = clientes.some(c => (c.nombre||"").toLowerCase() === nombre.toLowerCase());
    if (existe){
      alert("Ese cliente ya existe.");
      return;
    }

    const c = { id: Date.now(), nombre, telefono: tel };
    clientes.push(c);
    guardarDatos();
    cargarSelectClientes(c.id);
    toggleNuevoCliente();
    refrescarCreditos();
  }

  function cargarSelectClientes(seleccionarId = null){
    const sel = document.getElementById("clienteSelect");
    const opciones = [
      `<option value="">Seleccionar cliente...</option>`,
      ...clientes.map(c => `<option value="${c.id}">${c.nombre}${c.telefono ? " ("+c.telefono+")" : ""}</option>`)
    ];
    sel.innerHTML = opciones.join("");
    if (seleccionarId) sel.value = String(seleccionarId);
  }

  // =========================
  // ‚úÖ VENTAS / CR√âDITOS
  // =========================
  function toggleVenta(){
    const box = document.getElementById("ventaContainer");
    box.classList.toggle("active"); // ‚úÖ ahora s√≠ funciona con tu CSS
    if (!box.classList.contains("active")) cancelarVenta();
    else {
      resetVentaActual();
      cargarSelectClientes();
      cargarSelectProductosVenta();
      renderVentaItems();
      actualizarResumenVenta();
    }
  }

  function cancelarVenta(){
    const box = document.getElementById("ventaContainer");
    box.classList.remove("active");
    resetVentaActual();
  }

  function resetVentaActual(){
    ventaActual = { clienteId: null, items: [], abonoInicial: 0, nota: "" };
    document.getElementById("cantidadVenta").value = "";
    document.getElementById("abonoInicial").value = "";
    document.getElementById("notaVenta").value = "";
  }

  function cargarSelectProductosVenta(){
    const sel = document.getElementById("productoVentaSelect");
    const activos = productos
      .slice()
      .sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||""))
      .map(p => `<option value="${p.id}">${p.nombre} (${p.codigo || "S/C"}) - Stock: ${Number(p.stock||0)} - ‚Ç°${Number(p.precio||0).toFixed(2)}</option>`);
    sel.innerHTML = [`<option value="">Seleccionar producto...</option>`, ...activos].join("");
  }

  function agregarItemVenta(){
    const prodId = Number(document.getElementById("productoVentaSelect").value);
    const cant = Number(document.getElementById("cantidadVenta").value);

    if (!prodId || !cant || cant <= 0){
      alert("Seleccion√° producto y cantidad.");
      return;
    }

    const p = productos.find(x => x.id === prodId);
    if (!p){
      alert("Producto no encontrado.");
      return;
    }

    const stock = Number(p.stock || 0);
    if (cant > stock){
      alert(`No hay stock suficiente. Stock actual: ${stock}`);
      return;
    }

    const idx = ventaActual.items.findIndex(i => i.productId === prodId);
    if (idx >= 0){
      const nuevaCant = ventaActual.items[idx].cantidad + cant;
      if (nuevaCant > stock){
        alert(`No hay stock suficiente para sumar. Stock: ${stock}`);
        return;
      }
      ventaActual.items[idx].cantidad = nuevaCant;
      ventaActual.items[idx].subtotal = nuevaCant * Number(p.precio || 0);
    } else {
      ventaActual.items.push({
        productId: prodId,
        nombre: p.nombre || "",
        codigo: p.codigo || "",
        precio: Number(p.precio || 0),
        cantidad: cant,
        subtotal: cant * Number(p.precio || 0)
      });
    }

    document.getElementById("cantidadVenta").value = "";
    renderVentaItems();
    actualizarResumenVenta();
  }

  function quitarItemVenta(productId){
    ventaActual.items = ventaActual.items.filter(i => i.productId !== productId);
    renderVentaItems();
    actualizarResumenVenta();
  }

  function totalVentaActual(){
    return ventaActual.items.reduce((t,i)=> t + Number(i.subtotal||0), 0);
  }

  function actualizarResumenVenta(){
    const total = totalVentaActual();
    const abono = Number(document.getElementById("abonoInicial").value || 0);
    const saldo = Math.max(0, total - abono);

    document.getElementById("ventaItemsCount").textContent = `Items: ${ventaActual.items.length}`;
    document.getElementById("ventaTotal").textContent = `Total: ${money(total)}`;
    document.getElementById("ventaAbono").textContent = `Abono: ${money(abono)}`;
    document.getElementById("ventaSaldo").textContent = `Saldo: ${money(saldo)}`;
  }

  document.addEventListener("input", (e)=>{
    if (e.target && e.target.id === "abonoInicial") actualizarResumenVenta();
  });

  function renderVentaItems(){
    const body = document.getElementById("ventaItemsBody");
    if (!ventaActual.items.length){
      body.innerHTML = `
        <tr><td colspan="5" class="empty-state">
          <h3>Sin productos</h3><p>Agreg√° productos a la venta.</p>
        </td></tr>
      `;
      return;
    }

    body.innerHTML = ventaActual.items.map(i => `
      <tr>
        <td><strong>${i.nombre}</strong> <span style="color:#6b7280;">(${i.codigo})</span></td>
        <td class="center">${i.cantidad}</td>
        <td class="right">${money(i.precio)}</td>
        <td class="right">${money(i.subtotal)}</td>
        <td class="center">
          <button class="btn btn-gray" style="padding:8px 12px;" onclick="quitarItemVenta(${i.productId})">‚úñ</button>
        </td>
      </tr>
    `).join("");
  }

  function confirmarVenta(){
    const clienteId = Number(document.getElementById("clienteSelect").value);
    const abonoInicial = Number(document.getElementById("abonoInicial").value || 0);
    const nota = document.getElementById("notaVenta").value.trim();

    if (!clienteId){
      alert("Seleccion√° un cliente.");
      return;
    }
    if (!ventaActual.items.length){
      alert("Agreg√° al menos 1 producto.");
      return;
    }

    const total = totalVentaActual();
    if (abonoInicial < 0){
      alert("Abono inv√°lido.");
      return;
    }
    if (abonoInicial > total){
      alert("El abono no puede ser mayor que el total.");
      return;
    }

    // validar stock
    for (const it of ventaActual.items){
      const p = productos.find(x => x.id === it.productId);
      if (!p){
        alert("Error: un producto ya no existe.");
        return;
      }
      const stock = Number(p.stock || 0);
      if (it.cantidad > stock){
        alert(`Stock insuficiente para ${p.nombre}. Stock: ${stock}`);
        return;
      }
    }

    // aplicar descuento de stock
    for (const it of ventaActual.items){
      const p = productos.find(x => x.id === it.productId);
      p.stock = Math.max(0, Number(p.stock||0) - Number(it.cantidad||0));
      p.fechaActualizacion = new Date().toLocaleDateString();
    }

    const ventaId = Date.now();

    const venta = {
      id: ventaId,
      clienteId,
      fecha: new Date().toLocaleString(),
      items: JSON.parse(JSON.stringify(ventaActual.items)),
      total,
      abonado: abonoInicial,
      saldo: total - abonoInicial,
      nota: nota,
      pagos: []
    };

    if (abonoInicial > 0){
      const pago = {
        id: ventaId + 1,
        ventaId: ventaId,
        clienteId,
        fecha: new Date().toLocaleString(),
        monto: abonoInicial
      };
      venta.pagos.push(pago);
      abonos.push(pago);
    }

    ventas.push(venta);

    guardarDatos();
    refrescarTodo();
    cancelarVenta();
    alert("Venta guardada ‚úÖ");
  }

  function obtenerClienteNombre(id){
    const c = clientes.find(x => x.id === id);
    return c ? c.nombre : "Cliente";
  }

  function registrarAbono(ventaId){
    const v = ventas.find(x => x.id === ventaId);
    if (!v) return;

    if (v.saldo <= 0){
      alert("Esta venta ya est√° pagada ‚úÖ");
      return;
    }

    const txt = prompt(`Saldo actual: ${money(v.saldo)}\n¬øCu√°nto va a abonar?`);
    if (txt === null) return;

    const monto = Number(String(txt).replace(",", "."));
    if (!monto || monto <= 0){
      alert("Monto inv√°lido.");
      return;
    }
    if (monto > v.saldo){
      alert("El abono no puede ser mayor al saldo.");
      return;
    }

    v.abonado = Number(v.abonado || 0) + monto;
    v.saldo = Math.max(0, Number(v.total || 0) - Number(v.abonado || 0));

    const pago = {
      id: Date.now(),
      ventaId: v.id,
      clienteId: v.clienteId,
      fecha: new Date().toLocaleString(),
      monto
    };

    v.pagos.push(pago);
    abonos.push(pago);

    guardarDatos();
    refrescarCreditos();
    alert("Abono registrado ‚úÖ");
  }

  function eliminarVenta(ventaId){
    const v = ventas.find(x => x.id === ventaId);
    if (!v) return;

    if (!confirm("¬øEliminar esta venta? (No devuelve stock)")) return;

    abonos = abonos.filter(a => a.ventaId !== ventaId);
    ventas = ventas.filter(x => x.id !== ventaId);

    guardarDatos();
    refrescarCreditos();
  }

  function filtrarVentas(){
    const q = (document.getElementById("busquedaVentas").value || "").toLowerCase();
    const estado = document.getElementById("filtroEstadoVenta").value;

    let list = ventas.slice();

    if (q){
      list = list.filter(v => obtenerClienteNombre(v.clienteId).toLowerCase().includes(q));
    }

    if (estado === "pendiente"){
      list = list.filter(v => Number(v.saldo||0) > 0);
    } else if (estado === "pagada"){
      list = list.filter(v => Number(v.saldo||0) <= 0);
    }

    actualizarTablaVentas(list);
  }

  function actualizarTablaVentas(list = ventas){
    const tbody = document.getElementById("tablaVentas");
    if (!list.length){
      tbody.innerHTML = `
        <tr><td colspan="8" class="empty-state">
          <h3>No hay ventas</h3><p>Cre√° una venta a cr√©dito.</p>
        </td></tr>
      `;
      return;
    }

    const orden = list.slice().sort((a,b)=> b.id - a.id);

    tbody.innerHTML = orden.map(v => {
      const cliente = obtenerClienteNombre(v.clienteId);
      const productosTxt = (v.items || []).map(i => `${i.nombre} x${i.cantidad}`).join(", ");
      const estado = Number(v.saldo||0) > 0 ? "Pendiente" : "Pagada";
      const badge = Number(v.saldo||0) > 0 ? "pill yellow" : "pill green";

      return `
        <tr>
          <td>${v.fecha || ""}</td>
          <td><strong>${cliente}</strong></td>
          <td>${productosTxt}</td>
          <td class="right">${money(v.total)}</td>
          <td class="right">${money(v.abonado)}</td>
          <td class="right"><strong>${money(v.saldo)}</strong></td>
          <td class="center"><span class="${badge}">${estado}</span></td>
          <td class="center">
            <button class="btn btn-success" style="padding:8px 12px;" onclick="registrarAbono(${v.id})">üíµ Abonar</button>
            <button class="btn btn-gray" style="padding:8px 12px;" onclick="eliminarVenta(${v.id})">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  function actualizarTablaAbonos(){
    const tbody = document.getElementById("tablaAbonos");
    const list = abonos.slice().sort((a,b)=> b.id - a.id).slice(0,20);

    if (!list.length){
      tbody.innerHTML = `
        <tr><td colspan="4" class="empty-state">
          <h3>Sin abonos</h3><p>A√∫n no registr√°s pagos.</p>
        </td></tr>
      `;
      return;
    }

    tbody.innerHTML = list.map(a => `
      <tr>
        <td>${a.fecha || ""}</td>
        <td><strong>${obtenerClienteNombre(a.clienteId)}</strong></td>
        <td>#${a.ventaId}</td>
        <td class="right">${money(a.monto)}</td>
      </tr>
    `).join("");
  }

  function actualizarEstadisticasCreditos(){
    document.getElementById("totalClientes").textContent = clientes.length;
    document.getElementById("totalVentas").textContent = ventas.length;

    const deuda = ventas.reduce((t,v)=> t + Number(v.saldo||0), 0);
    const abon = ventas.reduce((t,v)=> t + Number(v.abonado||0), 0);

    document.getElementById("deudaTotal").textContent = money(deuda);
    document.getElementById("abonosTotal").textContent = money(abon);
  }

  function refrescarCreditos(){
    cargarSelectClientes();
    cargarSelectProductosVenta();
    actualizarTablaVentas(ventas);
    actualizarTablaAbonos();
    actualizarEstadisticasCreditos();
  }

  // =========================
  // ‚úÖ EXCEL / JSON (FIX DESCARGA)
  // =========================
  function descargarArchivo(nombre, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = nombre;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  function exportarExcel() {
    try{
      const wb = XLSX.utils.book_new();

      const inv = productos.map(p => ({
        "C√≥digo": p.codigo || "",
        "Nombre": p.nombre || "",
        "Categor√≠a": p.categoria || "",
        "Precio": Number(p.precio || 0),
        "Stock": Number(p.stock || 0),
        "Stock M√≠nimo": Number(p.stockMinimo || 5),
        "Vence": p.vence || "",
        "Proveedor": p.proveedor || "",
        "√öltima Actualizaci√≥n": p.fechaActualizacion || ""
      }));
      const wsInv = XLSX.utils.json_to_sheet(inv.length ? inv : [{Info:"Sin productos"}]);
      XLSX.utils.book_append_sheet(wb, wsInv, "Inventario");

      const cli = clientes.map(c => ({
        "ID": c.id,
        "Nombre": c.nombre || "",
        "Tel√©fono": c.telefono || ""
      }));
      const wsCli = XLSX.utils.json_to_sheet(cli.length ? cli : [{Info:"Sin clientes"}]);
      XLSX.utils.book_append_sheet(wb, wsCli, "Clientes");

      const ven = ventas.map(v => ({
        "ID Venta": v.id,
        "Fecha": v.fecha || "",
        "Cliente": obtenerClienteNombre(v.clienteId),
        "Total": Number(v.total || 0),
        "Abonado": Number(v.abonado || 0),
        "Saldo": Number(v.saldo || 0),
        "Productos": (v.items || []).map(i => `${i.nombre} x${i.cantidad}`).join(", "),
        "Nota": v.nota || ""
      }));
      const wsVen = XLSX.utils.json_to_sheet(ven.length ? ven : [{Info:"Sin ventas"}]);
      XLSX.utils.book_append_sheet(wb, wsVen, "Ventas");

      const abo = abonos.map(a => ({
        "ID Abono": a.id,
        "Fecha": a.fecha || "",
        "Venta": a.ventaId,
        "Cliente": obtenerClienteNombre(a.clienteId),
        "Monto": Number(a.monto || 0)
      }));
      const wsAbo = XLSX.utils.json_to_sheet(abo.length ? abo : [{Info:"Sin abonos"}]);
      XLSX.utils.book_append_sheet(wb, wsAbo, "Abonos");

      // ‚úÖ descarga robusta
      const excelArray = XLSX.write(wb, { bookType:"xlsx", type:"array" });
      const blob = new Blob([excelArray], { type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      descargarArchivo(`inventario_creditos_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`, blob);
    }catch(err){
      console.error(err);
      alert("No se pudo generar el Excel. Revis√° consola (F12).");
    }
  }

  function guardarJSON() {
    const data = { productos, clientes, ventas, abonos, fecha: new Date().toISOString() };

    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const dd = String(hoy.getDate()).padStart(2, '0');

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    descargarArchivo(`inventario_creditos_${yyyy}-${mm}-${dd}.json`, blob);
  }

  function cargarJSON(e) {
    const archivo = e.target.files[0];
    if (!archivo) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);

        if (!data || typeof data !== "object") {
          alert("Archivo inv√°lido.");
          return;
        }

        productos = Array.isArray(data.productos) ? data.productos : [];
        clientes  = Array.isArray(data.clientes) ? data.clientes : [];
        ventas    = Array.isArray(data.ventas) ? data.ventas : [];
        abonos    = Array.isArray(data.abonos) ? data.abonos : [];

        // normalizar vencimientos
        productos = productos.map(p => {
          const v = (p.vence || "").toString().trim();
          let venceNormal = "";
          if (v) {
            const fv = parseFechaVencimiento(v);
            if (fv) venceNormal = formatearFechaDDMMYYYY(fv);
          }
          return { ...p, vence: venceNormal };
        });

        guardarDatos();
        refrescarTodo();
        alert("Respaldo restaurado ‚úÖ");
      } catch (err) {
        alert("No se pudo cargar el JSON.");
      }
    };

    reader.readAsText(archivo);
    e.target.value = "";
  }

  // =========================
  // ‚úÖ IMPORT EXCEL INVENTARIO
  // =========================
  function importarExcel(e) {
    const archivo = e.target.files[0];
    if (!archivo) return;

    const reader = new FileReader();
    reader.onload = function (evento) {
      const datos = new Uint8Array(evento.target.result);
      const workbook = XLSX.read(datos, { type: 'array' });
      const hoja = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(hoja);

      const productosImportados = json.map(item => {
        const v = (item['Vence'] || item['Vencimiento'] || item['Fecha de vencimiento'] || '').toString().trim();
        let venceNormal = '';
        if (v) {
          const fv = parseFechaVencimiento(v);
          if (fv) venceNormal = formatearFechaDDMMYYYY(fv);
        }

        return {
          id: Date.now() + Math.random(),
          codigo: (item['C√≥digo'] || '').toString(),
          nombre: (item['Nombre'] || '').toString(),
          categoria: (item['Categor√≠a'] || '').toString(),
          precio: parseFloat(item['Precio']) || 0,
          stock: parseInt(item['Stock']) || 0,
          stockMinimo: parseInt(item['Stock M√≠nimo']) || 5,
          proveedor: (item['Proveedor'] || '').toString(),
          vence: venceNormal,
          fechaActualizacion: new Date().toLocaleDateString()
        };
      });

      productos = [...productos, ...productosImportados];
      guardarDatos();
      refrescarTodo();
      alert(`${productosImportados.length} productos importados ‚úÖ`);
    };

    reader.readAsArrayBuffer(archivo);
    e.target.value = '';
  }

  // =========================
  // ‚úÖ REFRESH TOTAL
  // =========================
  function refrescarTodo(){
    actualizarTablaInventario(productos);
    actualizarEstadisticasInventario();
    actualizarPanelVencimientos();
    refrescarCreditos();

    if (document.getElementById("ventaContainer").classList.contains("active")){
      cargarSelectClientes();
      cargarSelectProductosVenta();
      renderVentaItems();
      actualizarResumenVenta();
    }
  }
</script>
</body>
</html>

