<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Inventario - Suplementos</title>

  <!-- ‚úÖ PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }

    .header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
    .header p { color: #666; font-size: 1.1em; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; }
    .stat-card .value { font-size: 2em; font-weight: bold; }
    .stat-card .icon { font-size: 3em; opacity: 0.3; }

    .controls {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }

    .btn-info { background: #3b82f6; color: white; }
    .btn-info:hover { background: #2563eb; }

    .search-filter { display: flex; flex-wrap: wrap; gap: 15px; }

    .search-box { flex: 1; min-width: 250px; position: relative; }

    .search-box input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    .search-box input:focus { outline: none; border-color: #667eea; }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    select {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      background: white;
    }

    .form-container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: none;
    }

    .form-container.active { display: block; }
    .form-container h2 { margin-bottom: 20px; color: #333; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-grid input, .form-grid select {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
    }

    .form-grid input:focus, .form-grid select:focus {
      outline: none;
      border-color: #667eea;
    }

    .table-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; }
    thead { background: #667eea; color: white; }
    thead th { padding: 15px; text-align: left; font-weight: 600; }

    tbody tr {
      border-bottom: 1px solid #e5e7eb;
      transition: background-color 0.2s;
    }

    tbody tr:hover { background: #f9fafb; }
    tbody tr.stock-bajo { background: #fee2e2; }
    tbody tr.stock-bajo:hover { background: #fecaca; }

    tbody td { padding: 15px; }

    .categoria-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      background: #ddd6fe;
      color: #5b21b6;
    }

    .stock-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .stock-btn {
      width: 30px;
      height: 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2em;
      transition: all 0.2s;
    }

    .stock-btn.minus { background: #ef4444; color: white; }
    .stock-btn.plus { background: #10b981; color: white; }
    .stock-btn:hover { transform: scale(1.1); }

    .stock-value { font-weight: bold; min-width: 40px; text-align: center; }

    .action-btns { display: flex; gap: 10px; justify-content: center; }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      transition: transform 0.2s;
    }

    .icon-btn:hover { transform: scale(1.2); }
    .icon-btn.edit { color: #3b82f6; }
    .icon-btn.delete { color: #ef4444; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.8em; }
      .stats { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .table-container { overflow-x: auto; }
      table { min-width: 800px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üì¶ Control de Inventario - Suplementos</h1>
      <p>Gestiona tu inventario de manera eficiente</p>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div>
          <h3>Total Productos</h3>
          <div class="value" style="color: #667eea;" id="totalProductos">0</div>
        </div>
        <div class="icon">üì¶</div>
      </div>

      <div class="stat-card">
        <div>
          <h3>Valor Inventario</h3>
          <div class="value" style="color: #10b981;" id="valorInventario">‚Ç°0.00</div>
        </div>
        <div class="icon">üí∞</div>
      </div>

      <div class="stat-card">
        <div>
          <h3>Stock Bajo</h3>
          <div class="value" style="color: #ef4444;" id="stockBajo">0</div>
        </div>
        <div class="icon">‚ö†Ô∏è</div>
      </div>

      <div class="stat-card">
        <div>
          <h3>Categor√≠as</h3>
          <div class="value" style="color: #8b5cf6;" id="totalCategorias">7</div>
        </div>
        <div class="icon">üìÇ</div>
      </div>
    </div>

    <div class="controls">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="toggleFormulario()">‚ûï Agregar Producto</button>

        <button class="btn btn-success" onclick="exportarExcel()">‚¨áÔ∏è Exportar Excel</button>

        <label class="btn btn-info">
          ‚¨ÜÔ∏è Importar Excel
          <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="importarExcel(event)">
        </label>

        <!-- ‚úÖ Respaldo en PC -->
        <button class="btn btn-success" onclick="guardarJSON()">üíæ Respaldo en PC (JSON)</button>

        <label class="btn btn-info">
          üìÇ Restaurar Respaldo (JSON)
          <input type="file" id="importJSON" accept=".json" style="display: none;" onchange="cargarJSON(event)">
        </label>
      </div>

      <div class="search-filter">
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" id="busqueda" placeholder="Buscar por nombre o c√≥digo..." oninput="filtrarProductos()">
        </div>

        <select id="filtroCategoria" onchange="filtrarProductos()">
          <option value="todos">Todas las categor√≠as</option>
          <option value="Prote√≠nas">Prote√≠nas</option>
          <option value="Vitaminas">Vitaminas</option>
          <option value="Amino√°cidos">Amino√°cidos</option>
          <option value="Pre-Entreno">Pre-Entreno</option>
          <option value="Creatina">Creatina</option>
          <option value="Quemadores">Quemadores</option>
          <option value="Otros">Otros</option>
        </select>
      </div>
    </div>

    <div class="form-container" id="formContainer">
      <h2 id="formTitle">Nuevo Producto</h2>

      <div class="form-grid">
        <input type="text" id="codigo" placeholder="C√≥digo">
        <input type="text" id="nombre" placeholder="Nombre *" required>

        <select id="categoria">
          <option value="">Seleccionar categor√≠a</option>
          <option value="Prote√≠nas">Prote√≠nas</option>
          <option value="Vitaminas">Vitaminas</option>
          <option value="Amino√°cidos">Amino√°cidos</option>
          <option value="Pre-Entreno">Pre-Entreno</option>
          <option value="Creatina">Creatina</option>
          <option value="Quemadores">Quemadores</option>
          <option value="Otros">Otros</option>
        </select>

        <input type="number" id="precio" placeholder="Precio *" step="0.01" required>
        <input type="number" id="stock" placeholder="Stock *" required>
        <input type="number" id="stockMinimo" placeholder="Stock M√≠nimo" value="5">
        <input type="text" id="proveedor" placeholder="Proveedor">
        <input type="text" id="ubicacion" placeholder="Ubicaci√≥n">
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="guardarProducto()">üíæ Guardar</button>
        <button class="btn" style="background: #6b7280; color: white;" onclick="cancelarFormulario()">‚ùå Cancelar</button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th style="text-align: right;">Precio</th>
            <th style="text-align: center;">Stock</th>
            <th style="text-align: center;">Stock M√≠n.</th>
            <th>Proveedor</th>
            <th style="text-align: center;">Acciones</th>
          </tr>
        </thead>

        <tbody id="tablaProductos">
          <tr>
            <td colspan="8" class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <h3>No hay productos registrados</h3>
              <p>¬°Agrega tu primer producto para comenzar!</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let productos = [];
    let editandoId = null;

    // ‚úÖ AUTOCARGA
    window.onload = function () {
      cargarDatos();
      actualizarTabla();
      actualizarEstadisticas();
    };

    // ‚úÖ PWA Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js")
          .catch(err => console.log("SW error:", err));
      });
    }

    function cargarDatos() {
      try {
        const datosGuardados = localStorage.getItem('inventarioSuplementos');
        productos = datosGuardados ? JSON.parse(datosGuardados) : [];
        if (!Array.isArray(productos)) productos = [];
      } catch (e) {
        productos = [];
      }
    }

    function guardarDatos() {
      localStorage.setItem('inventarioSuplementos', JSON.stringify(productos));
    }

    function toggleFormulario() {
      const form = document.getElementById('formContainer');
      form.classList.toggle('active');
      if (!form.classList.contains('active')) cancelarFormulario();
    }

    function cancelarFormulario() {
      document.getElementById('formContainer').classList.remove('active');
      document.getElementById('formTitle').textContent = 'Nuevo Producto';
      limpiarFormulario();
      editandoId = null;
    }

    function limpiarFormulario() {
      document.getElementById('codigo').value = '';
      document.getElementById('nombre').value = '';
      document.getElementById('categoria').value = '';
      document.getElementById('precio').value = '';
      document.getElementById('stock').value = '';
      document.getElementById('stockMinimo').value = '5';
      document.getElementById('proveedor').value = '';
      document.getElementById('ubicacion').value = '';
    }

    function guardarProducto() {
      const nombre = document.getElementById('nombre').value;
      const precio = document.getElementById('precio').value;
      const stock = document.getElementById('stock').value;

      if (!nombre || !precio || !stock) {
        alert('Por favor completa los campos obligatorios: Nombre, Precio y Stock');
        return;
      }

      const producto = {
        id: editandoId || Date.now(),
        codigo: document.getElementById('codigo').value || '',
        nombre: nombre,
        categoria: document.getElementById('categoria').value || '',
        precio: parseFloat(precio),
        stock: parseInt(stock),
        stockMinimo: parseInt(document.getElementById('stockMinimo').value) || 5,
        proveedor: document.getElementById('proveedor').value || '',
        ubicacion: document.getElementById('ubicacion').value || '',
        fechaActualizacion: new Date().toLocaleDateString()
      };

      if (editandoId) {
        const index = productos.findIndex(p => p.id === editandoId);
        productos[index] = producto;
      } else {
        productos.push(producto);
      }

      guardarDatos();
      actualizarTabla();
      actualizarEstadisticas();
      cancelarFormulario();
    }

    function editarProducto(id) {
      const producto = productos.find(p => p.id === id);
      if (!producto) return;

      document.getElementById('codigo').value = producto.codigo || '';
      document.getElementById('nombre').value = producto.nombre || '';
      document.getElementById('categoria').value = producto.categoria || '';
      document.getElementById('precio').value = producto.precio ?? '';
      document.getElementById('stock').value = producto.stock ?? '';
      document.getElementById('stockMinimo').value = producto.stockMinimo ?? 5;
      document.getElementById('proveedor').value = producto.proveedor || '';
      document.getElementById('ubicacion').value = producto.ubicacion || '';

      editandoId = id;
      document.getElementById('formTitle').textContent = 'Editar Producto';
      document.getElementById('formContainer').classList.add('active');
    }

    function eliminarProducto(id) {
      if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
        productos = productos.filter(p => p.id !== id);
        guardarDatos();
        actualizarTabla();
        actualizarEstadisticas();
      }
    }

    function ajustarStock(id, cantidad) {
      const producto = productos.find(p => p.id === id);
      if (producto) {
        producto.stock = Math.max(0, (Number(producto.stock) || 0) + cantidad);
        producto.fechaActualizacion = new Date().toLocaleDateString();
        guardarDatos();
        actualizarTabla();
        actualizarEstadisticas();
      }
    }

    function filtrarProductos() {
      const busqueda = document.getElementById('busqueda').value.toLowerCase();
      const categoria = document.getElementById('filtroCategoria').value;

      const productosFiltrados = productos.filter(p => {
        const coincideBusqueda =
          (p.nombre || '').toLowerCase().includes(busqueda) ||
          (p.codigo || '').toLowerCase().includes(busqueda);

        const coincideCategoria = categoria === 'todos' || p.categoria === categoria;
        return coincideBusqueda && coincideCategoria;
      });

      actualizarTabla(productosFiltrados);
    }

    function actualizarTabla(productosMostrar = productos) {
      const tbody = document.getElementById('tablaProductos');

      if (!productosMostrar || productosMostrar.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <h3>No hay productos registrados</h3>
              <p>¬°Agrega tu primer producto para comenzar!</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = productosMostrar.map(p => `
        <tr class="${Number(p.stock || 0) <= Number(p.stockMinimo || 5) ? 'stock-bajo' : ''}">
          <td>${p.codigo || ''}</td>
          <td><strong>${p.nombre || ''}</strong></td>
          <td><span class="categoria-badge">${p.categoria || ''}</span></td>
          <td style="text-align: right;">‚Ç°${Number(p.precio || 0).toFixed(2)}</td>
          <td>
            <div class="stock-controls">
              <button class="stock-btn minus" onclick="ajustarStock(${p.id}, -1)">-</button>
              <span class="stock-value">${Number(p.stock || 0)}</span>
              <button class="stock-btn plus" onclick="ajustarStock(${p.id}, 1)">+</button>
            </div>
          </td>
          <td style="text-align: center;">${Number(p.stockMinimo || 5)}</td>
          <td>${p.proveedor || ''}</td>
          <td>
            <div class="action-btns">
              <button class="icon-btn edit" onclick="editarProducto(${p.id})" title="Editar">‚úèÔ∏è</button>
              <button class="icon-btn delete" onclick="eliminarProducto(${p.id})" title="Eliminar">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function actualizarEstadisticas() {
      document.getElementById('totalProductos').textContent = productos.length;

      const valor = productos.reduce((total, p) => {
        return total + (Number(p.precio || 0) * Number(p.stock || 0));
      }, 0);

      document.getElementById('valorInventario').textContent = `‚Ç°${valor.toFixed(2)}`;

      const stockBajo = productos.filter(p => Number(p.stock || 0) <= Number(p.stockMinimo || 5)).length;
      document.getElementById('stockBajo').textContent = stockBajo;
    }

    function exportarExcel() {
      if (productos.length === 0) {
        alert('No hay productos para exportar');
        return;
      }

      const datosExportar = productos.map(p => ({
        'C√≥digo': p.codigo || '',
        'Nombre': p.nombre || '',
        'Categor√≠a': p.categoria || '',
        'Precio': Number(p.precio || 0),
        'Stock': Number(p.stock || 0),
        'Stock M√≠nimo': Number(p.stockMinimo || 5),
        'Proveedor': p.proveedor || '',
        'Ubicaci√≥n': p.ubicacion || '',
        '√öltima Actualizaci√≥n': p.fechaActualizacion || ''
      }));

      const ws = XLSX.utils.json_to_sheet(datosExportar);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
      XLSX.writeFile(wb, `inventario_suplementos_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
    }

    function importarExcel(e) {
      const archivo = e.target.files[0];
      if (!archivo) return;

      const reader = new FileReader();
      reader.onload = function (evento) {
        const datos = new Uint8Array(evento.target.result);
        const workbook = XLSX.read(datos, { type: 'array' });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(hoja);

        const productosImportados = json.map(item => ({
          id: Date.now() + Math.random(),
          codigo: item['C√≥digo'] || '',
          nombre: item['Nombre'] || '',
          categoria: item['Categor√≠a'] || '',
          precio: parseFloat(item['Precio']) || 0,
          stock: parseInt(item['Stock']) || 0,
          stockMinimo: parseInt(item['Stock M√≠nimo']) || 5,
          proveedor: item['Proveedor'] || '',
          ubicacion: item['Ubicaci√≥n'] || '',
          fechaActualizacion: new Date().toLocaleDateString()
        }));

        productos = [...productos, ...productosImportados];
        guardarDatos();
        actualizarTabla();
        actualizarEstadisticas();
        alert(`${productosImportados.length} productos importados exitosamente`);
      };

      reader.readAsArrayBuffer(archivo);
      e.target.value = '';
    }

    // ‚úÖ Respaldo JSON en PC
    function guardarJSON() {
      const data = { productos, fecha: new Date().toISOString() };

      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `inventario_suplementos_${yyyy}-${mm}-${dd}.json`;
      a.click();

      URL.revokeObjectURL(url);
    }

    function cargarJSON(e) {
      const archivo = e.target.files[0];
      if (!archivo) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);

          if (!data.productos || !Array.isArray(data.productos)) {
            alert("Archivo inv√°lido: no contiene 'productos' correctamente.");
            return;
          }

          productos = data.productos;
          guardarDatos(); // ‚úÖ para que al abrir la app vuelva a salir
          actualizarTabla();
          actualizarEstadisticas();
          alert("Respaldo restaurado ‚úÖ");
        } catch (err) {
          alert("No se pudo cargar el archivo JSON (formato inv√°lido).");
        }
      };

      reader.readAsText(archivo);
      e.target.value = "";
    }
  </script>
</body>
</html>
